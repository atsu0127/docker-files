# JSON Relation Duality

以下の記事を試してみます。

https://qiita.com/takuya_0301/items/d56628e22cdba8b222ed

## 手順

### コンテナ接続
```bash
docker compose exec -it ords bash
```

### 表など作成

```sql
-- 一回消す
drop view if exists team_dv;
drop view if exists race_dv;
drop view if exists driver_dv;
drop table if exists driver_race_map;
drop table if exists race;
drop table if exists driver;
drop table if exists team;

-- 表作成
CREATE TABLE IF NOT EXISTS team
(team_id INTEGER GENERATED BY DEFAULT ON NULL AS IDENTITY,
   name    VARCHAR2(255) NOT NULL UNIQUE,
   points  INTEGER NOT NULL,
   CONSTRAINT team_pk PRIMARY KEY(team_id));

CREATE TABLE IF NOT EXISTS driver
(driver_id INTEGER GENERATED BY DEFAULT ON NULL AS IDENTITY,
 name VARCHAR2(255) NOT NULL UNIQUE,
 points INTEGER NOT NULL,
 team_id INTEGER,
CONSTRAINT driver_pk PRIMARY KEY(driver_id),
CONSTRAINT driver_fk FOREIGN KEY(team_id) REFERENCES team(team_id));

CREATE TABLE IF NOT EXISTS race
(race_id INTEGER GENERATED BY DEFAULT ON NULL AS IDENTITY,
   name      VARCHAR2(255) NOT NULL UNIQUE,
   laps      INTEGER NOT NULL,
   race_date DATE,
   podium  JSON,
   CONSTRAINT   race_pk PRIMARY KEY(race_id));

CREATE TABLE IF NOT EXISTS driver_race_map
(driver_race_map_id INTEGER GENERATED BY DEFAULT ON NULL AS IDENTITY,
race_id INTEGER NOT NULL,
driver_id INTEGER NOT NULL,
position INTEGER,
CONSTRAINT driver_race_map_pk PRIMARY KEY(driver_race_map_id),
CONSTRAINT driver_race_map_fk1 FOREIGN KEY(race_id) REFERENCES race(race_id),
CONSTRAINT driver_race_map_fk2 FOREIGN KEY(driver_id) REFERENCES driver(driver_id));

-- Trigger作成
-- driver_race_mapの更新時にpositionに基づいてteamとdriverのpointを更新する
CREATE OR REPLACE TRIGGER driver_race_map_trigger BEFORE INSERT ON driver_race_map
FOR EACH ROW
DECLARE
    v_points  INTEGER;
    v_team_id INTEGER;
BEGIN
SELECT team_id INTO v_team_id FROM driver WHERE driver_id = :NEW.driver_id;
IF :NEW.position = 1 THEN
    v_points := 25;
ELSIF :NEW.position = 2 THEN
  v_points := 18;
ELSIF :NEW.position = 3 THEN
  v_points := 15;
ELSIF :NEW.position = 4 THEN
  v_points := 12;
ELSIF :NEW.position = 5 THEN
  v_points := 10;
ELSIF :NEW.position = 6 THEN
  v_points := 8;
ELSIF :NEW.position = 7 THEN
  v_points := 6;
ELSIF :NEW.position = 8 THEN
  v_points := 4;
ELSIF :NEW.position = 9 THEN
  v_points := 2;
ELSIF :NEW.position = 10 THEN
  v_points := 1;
ELSE
  v_points := 0;
END IF;
UPDATE driver SET points = points + v_points
 WHERE driver_id = :NEW.driver_id;
UPDATE team SET points = points + v_points
    WHERE team_id = v_team_id;
END;
/

-- Duality View作成
CREATE OR REPLACE JSON RELATIONAL DUALITY VIEW race_dv AS
  race @insert @update @delete
  {
    raceId : race_id
    name   : name
    laps   : laps @noUpdate
    date   : race_date
    podium : podium @noCheck
    result : driver_race_map @insert @update @delete
    [
      {
        driverRaceMapId : driver_race_map_id
        position        : position
        driver @noInsert @update @noDelete @unnest
        {
          driverId : driver_id
          name     : name
        }
      }
    ]
  };

CREATE OR REPLACE JSON RELATIONAL DUALITY VIEW driver_dv AS
  driver @insert @update @delete
  {
    driverId : driver_id
    name     : name
    points   : points
    team @noInsert @noUpdate @noDelete @unnest
    {
      teamId : team_id
      team   : name @noCheck
    }
    race : driver_race_map @insert @update @noDelete
    [
     {
      driverRaceMapId : driver_race_map_id
      race @noInsert @noUpdate @noDelete @unnest
      {
        raceId : race_id
        name   : name
      }
      finalPosition   : position
     }
    ]
  };

CREATE OR REPLACE JSON RELATIONAL DUALITY VIEW team_dv AS
  team @insert @update @delete
  {
    teamId : team_id
    name   : name
    points : points
    driver : driver @insert @update
    [
      {
        driverId : driver_id
        name     : name
        points   : points @noCheck
      }
    ]
  };


-- 有効化
BEGIN
    ORDS.ENABLE_OBJECT(
        P_ENABLED  => TRUE,
        P_SCHEMA => 'JRD',
        P_OBJECT  =>  'DRIVER_DV',
        P_OBJECT_TYPE => 'VIEW',
        P_OBJECT_ALIAS => 'driver_dv',
        P_AUTO_REST_AUTH => FALSE
    );
    COMMIT;
END;
/
BEGIN
    ORDS.ENABLE_OBJECT(
        P_ENABLED => TRUE,
        P_SCHEMA => 'JRD',
        P_OBJECT =>  'RACE_DV',
        P_OBJECT_TYPE => 'VIEW',
        P_OBJECT_ALIAS => 'race_dv',
        P_AUTO_REST_AUTH => FALSE
    );
    COMMIT;
END;
/
BEGIN
    ORDS.ENABLE_OBJECT(
        P_ENABLED => TRUE,
        P_SCHEMA => 'JRD',
        P_OBJECT =>  'TEAM_DV',
        P_OBJECT_TYPE => 'VIEW',
        P_OBJECT_ALIAS => 'team_dv',
        P_AUTO_REST_AUTH => FALSE
    );
    COMMIT;
END;
/
```

### 検証

- データ投入

```bash
## curlしてみる
curl http://localhost:8080/ords/jrd/team_dv/ | jq

## data投入
cat << 'EOF' >| data.json
{
    "teamId": 2,
    "name": "Mercedes",
    "points": 0,
    "driver": [
        {
            "driverId": 105,
            "name": "George Russell",
            "points": 0
        },
        {
            "driverId": 106,
            "name": "Lewis Hamilton",
            "points": 0
        }
    ]
}
EOF
curl -i -X POST \
  --data-binary @data.json \
  -H "Content-Type: application/json" \
  http://localhost:8080/ords/jrd/team_dv/

## データ確認
curl http://localhost:8080/ords/jrd/team_dv/ | jq
```

- データ更新

```bash
## 既存のdriver確認
curl http://localhost:8080/ords/jrd/driver_dv/ | jq '.items[0]'

## etag指定して更新
cat << 'EOF' >| data2.json
{
    "_metadata": {
        "etag": "<↑のetag入れる>"
    },
    "driverId": 105,
    "name": "Max Emilian Verstappen",
    "points": 0,
    "teamId": 2,
    "race": []
}
EOF

## 更新
curl -i -X PUT \
  --data-binary @data2.json \
  -H "Content-Type: application/json" \
  http://localhost:8080/ords/jrd/driver_dv/105

## 確認
curl http://localhost:8080/ords/jrd/driver_dv/ | jq
```

- sql で確認

```sql
-- 表確認
set lines 500 pages 100 tab off
col NAME for a30
select * from driver;
select * from team;
```
